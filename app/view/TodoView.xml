<ui:View xmlns="http://www.w3.org/1999/xhtml"
         xmlns:js="js.core" xmlns:ui="js.ui">
    <js:Script>
        <![CDATA[
        (function () {
            var ENTER_KEY = 13;

            return {
                defaults: {
                    componentClass: "todo",
                    editing: false
                },
                events: [
                    "remove"
                ],
                editTodo: function (e, div) {
                    var todo = div.find("$item");
                    this.set("editing", true);
                    e.$.stopPropagation();
                    // we don't use jquery, so we have to select this the old fashioned way
                    div.$el.parentNode.parentNode.getElementsByTagName("input")[1].select();
                },
                checkTodo: function (e, input) {
                    var todo = this.get("todo");
                    todo.setCompleted(!todo.isCompleted());
                },
                updateTodo: function (e, input) {
                    var todo;
                    if (e.$.keyCode === ENTER_KEY) {
                        todo = this.get("todo");
                        if (!todo.hasTitle()) {
                            this.trigger("onremove", todo);
                        } else {
                            this.set("editing", false);
                        }
                    } else if (e.$.type === "blur") {
                        todo = this.get("todo");
                        this.set("editing", false);
                    }
                },
                triggerOnRemove: function (e, el) {
                    this.trigger("onremove", this.get("todo"));
                },
                _renderEditing: function (editing) {
                    if (editing) {
                        this.addClass("editing");
                    } else {
                        this.removeClass("editing");
                    }
                }

            }
        })
        ]]>
    </js:Script>
    <js:Template name="layout">
        <div class="{todo.status()}">
            <div class="view">
                <input class="toggle" type="checkbox" onchange="checkTodo"
                       checked="{todo.completed}"/>
                <label ondblclick="editTodo">{todo.title}</label>
                <button class="destroy" onclick="triggerOnRemove"/>
            </div>
            <input class="edit" type="text" value="{{todo.title}}"
                   onkeyup="updateTodo" onblur="updateTodo"/>
        </div>
    </js:Template>
</ui:View>

