<ui:View xmlns="http://www.w3.org/1999/xhtml"
         xmlns:js="js.core" xmlns:ui="js.ui">
    <js:Script>
        <![CDATA[
        (function (Base, Bindable, Content) {
            return {
                defaults:{
                    componentClass:"todo",
                    editing:false
                },
                events:[
                    "remove"
                ],
                editTodo:function (e, div) {
                    var todo = div.find("$item");
                    this.set("editing", true);
                    e.$.stopPropagation();
                    // we don't use jquery, so we have to select this the old fashioned way
                    div.$el.parentNode.parentNode.getElementsByTagName("input")[1].select();
                },
                checkTodo:function (e, input) {
                    var todo = this.get("todo");
                    todo.setDone(!todo.get("isDone"));
                },
                updateTodo:function (e, input) {
                    var todo;
                    if (e.$.keyCode === 13) {
                        todo = this.get("todo");
                        if (!todo.hasContent()) {
                            this.trigger("onremove", todo);
                        }else{
                            this.set("editing", false);
                        }
                    } else if (e.$.keyCode === 27) {
                        todo = this.get("todo");
                        var content = todo.get("content");

                        input.$el.blur();

                        todo.set("content", content);
                        this.set("editing", false);
                    } else if (e.$.type === "blur") {
                        todo = this.get("todo");
                        this.set("editing", false);
                    }
                },
                triggerOnRemove:function (e, el) {
                    this.trigger("onremove", this.get("todo"));
                },
                _renderEditing:function (editing) {
                    if (editing) {
                        this.addClass("editing");
                    } else {
                        this.removeClass("editing");
                    }
                }

            }
        })
        ]]>
    </js:Script>
    <js:Template name="layout">
        <div class="{todo.status()}">
            <div class="view">
                <input class="toggle" type="checkbox" onchange="checkTodo"
                       checked="{todo.isDone}"/>
                <label ondblclick="editTodo">{todo.content}</label>
                <button class="destroy" onclick="triggerOnRemove"/>
            </div>
            <input class="edit" type="text" value="{{todo.content}}"
                   onkeyup="updateTodo" onblur="updateTodo"/>
        </div>
    </js:Template>
</ui:View>

